<div class="container admin-container">
  <button
    class="sidebar-toggle-btn"
    type="button"
    aria-label="Abrir menu"
    aria-controls="adminSidebar"
    [attr.aria-expanded]="sidebarOpen()"
    (click)="toggleSidebar()"
    title="Menu"
  >
    ☰
  </button>

  <header class="admin-header">
    <div>
      <h1 class="admin-title">Painel (Admin)</h1>
      <div class="admin-sub">Visão do dia de todos os usuários (contas, ritmo e saldo).</div>
    </div>

    <div class="admin-actions">
      <button class="sidebar-action" type="button" (click)="goBack()">← Voltar</button>
      <button class="sidebar-action" type="button" (click)="toggleLive()">
        {{ liveEnabled() ? 'Ao vivo: ON' : 'Ao vivo: OFF' }}
      </button>
      <button class="sidebar-action" type="button" (click)="openBroadcastHistory()">Histórico</button>
      <button class="sidebar-action" type="button" (click)="refresh()" [disabled]="loading()">Atualizar</button>
    </div>
  </header>

  <div class="admin-toolbar">
    <div class="admin-toolbar-left">
      <span class="admin-pill">{{ selectedDayLabel() }}</span>

      <label class="admin-day-field">
        <span class="admin-field-label">Dia</span>
        <input class="admin-input admin-input--date" type="date" [ngModel]="selectedDayYmd()" (ngModelChange)="setSelectedDay($event)" />
      </label>

      <button class="admin-sort-btn" type="button" (click)="setSelectedDayToday()">Hoje</button>
    </div>

    <div class="admin-toolbar-right">
      <span class="admin-muted">Atualizado: {{ asOfIso() | date:'HH:mm:ss' }}</span>
      <span class="admin-muted" *ngIf="loading()">Carregando…</span>
    </div>
  </div>

  <div class="admin-error" *ngIf="errorText()">{{ errorText() }}</div>

  <section class="admin-kpis">
    <div class="admin-kpi">
      <div class="admin-kpi-label">Usuários</div>
      <div class="admin-kpi-value">{{ kpiTotalUsers() }}</div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-label">Contas</div>
      <div class="admin-kpi-value">{{ kpiTotalTx() }}</div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-label">Unidades</div>
      <div class="admin-kpi-value">{{ kpiTotalUnits() }}</div>
    </div>
    <div class="admin-kpi">
      <div class="admin-kpi-label">Saldo (Gasto - TMA)</div>
      <div class="admin-kpi-value" [class.ok]="abs(kpiTotalSaldo()) <= 600" [class.bad]="abs(kpiTotalSaldo()) > 600">
        {{ formatDiff(kpiTotalSaldo()) }}
      </div>
    </div>
  </section>

  <section class="admin-controls">
    <label class="admin-field">
      <span class="admin-field-label">Buscar</span>
      <input class="admin-input" type="text" placeholder="Nome ou user_id" [ngModel]="query()" (ngModelChange)="query.set($event)" />
    </label>

    <label class="admin-check">
      <input type="checkbox" [checked]="showAdmins()" (change)="showAdmins.set($any($event.target).checked)" />
      <span>Mostrar admins</span>
    </label>

    <div class="admin-sort">
      <span class="admin-muted">Ordenar:</span>
      <button
        class="admin-sort-btn"
        type="button"
        (click)="setSort('units')"
        [class.is-active]="sortKey() === 'units'"
        [attr.aria-pressed]="sortKey() === 'units'"
      >
        Unidades <span class="admin-sort-arrow" *ngIf="sortKey() === 'units'">{{ sortDir() === 'asc' ? '↑' : '↓' }}</span>
      </button>
      <button
        class="admin-sort-btn"
        type="button"
        (click)="setSort('accounts')"
        [class.is-active]="sortKey() === 'accounts'"
        [attr.aria-pressed]="sortKey() === 'accounts'"
      >
        Contas <span class="admin-sort-arrow" *ngIf="sortKey() === 'accounts'">{{ sortDir() === 'asc' ? '↑' : '↓' }}</span>
      </button>
      <button
        class="admin-sort-btn"
        type="button"
        (click)="setSort('saldo')"
        [class.is-active]="sortKey() === 'saldo'"
        [attr.aria-pressed]="sortKey() === 'saldo'"
      >
        Saldo <span class="admin-sort-arrow" *ngIf="sortKey() === 'saldo'">{{ sortDir() === 'asc' ? '↑' : '↓' }}</span>
      </button>
      <button
        class="admin-sort-btn"
        type="button"
        (click)="setSort('last')"
        [class.is-active]="sortKey() === 'last'"
        [attr.aria-pressed]="sortKey() === 'last'"
      >
        Última <span class="admin-sort-arrow" *ngIf="sortKey() === 'last'">{{ sortDir() === 'asc' ? '↑' : '↓' }}</span>
      </button>
    </div>
  </section>

  <section class="admin-liveboard">
    <div class="admin-liveboard-head">
      <div>
        <div class="admin-liveboard-title">Timeline 24h</div>
        <div class="admin-liveboard-sub">Visão ao vivo do dia (trabalho, TT e ociosidade) por usuário.</div>
        <div class="admin-liveboard-periods" aria-hidden="true">
          <span [class.is-active]="timelineDayPart() === 0">Madrugada</span>
          <span [class.is-active]="timelineDayPart() === 1">Manhã</span>
          <span [class.is-active]="timelineDayPart() === 2">Tarde</span>
          <span [class.is-active]="timelineDayPart() === 3">Noite</span>
        </div>
      </div>

      <div class="admin-liveboard-side">
        <div class="admin-stock">
          <div class="admin-stock-label">Estoque (contas)</div>
          <div class="admin-stock-value">{{ inventoryRemaining() === null ? '—' : inventoryRemaining() }}</div>
          <div class="admin-stock-editor">
            <input
              class="admin-input admin-stock-input"
              type="number"
              min="0"
              step="1"
              [ngModel]="inventoryDraft()"
              (ngModelChange)="inventoryDraft.set($event)"
              aria-label="Editar estoque"
            />
            <button class="admin-sort-btn" type="button" (click)="saveInventory()" [disabled]="inventorySaving()">
              {{ inventorySaving() ? 'Salvando…' : 'Salvar' }}
            </button>
          </div>
          <div class="admin-stock-sub" *ngIf="inventoryUpdatedAtIso()">Atualizado: {{ inventoryUpdatedAtIso() | date:'HH:mm' }}</div>
          <div class="admin-stock-err" *ngIf="inventoryError()">{{ inventoryError() }}</div>
        </div>

        <div class="admin-liveboard-legend" aria-label="Legenda">
          <span class="legend-dot work" title="Trabalho"></span>
          <span class="legend-dot tt" title="Time Tracker"></span>
          <span class="legend-dot idle" title="Ociosidade"></span>
        </div>

        <div class="admin-timeline-key" aria-label="Guia de cores da timeline">
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-work" aria-hidden="true"></span>
            <span>Trabalho (contas)</span>
          </div>
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-tt" aria-hidden="true"></span>
            <span>Time Tracker</span>
          </div>
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-idle" aria-hidden="true"></span>
            <span>Ociosidade involuntária</span>
          </div>
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-start" aria-hidden="true"></span>
            <span>Início do dia</span>
          </div>
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-end" aria-hidden="true"></span>
            <span>Fim do dia</span>
          </div>
          <div class="admin-timeline-key-row">
            <span class="admin-timeline-swatch sw-now" aria-hidden="true"></span>
            <span>Agora</span>
          </div>
        </div>
      </div>
    </div>

    <div class="admin-liveboard-axis" aria-hidden="true">
      <span>00</span>
      <span>06</span>
      <span>12</span>
      <span>18</span>
      <span>24</span>
    </div>

    <div class="admin-liveboard-body">
      <div class="admin-livelane" *ngFor="let r of rows()">
        <div class="admin-livelane-name" [class.is-active]="isInProgress(r.userId)">
          <span class="admin-livelane-dot" [class.on]="isInProgress(r.userId) || isRecentlyActive(r.lastTxAtIso)"></span>
          <span class="admin-livelane-text">{{ r.username }}</span>
        </div>

        <div class="admin-livelane-track">
          <span
            class="admin-liveboard-now"
            *ngIf="timelineNowPct() !== null"
            [style.left.%]="timelineNowPct()!"
            aria-hidden="true"
          ></span>

          <span
            class="admin-liveboard-marker"
            *ngFor="let m of timelineMarkers(r.userId)"
            [class.marker-start]="m.kind === 'day_start'"
            [class.marker-end]="m.kind === 'day_end'"
            [style.left.%]="m.leftPct"
            [title]="m.title"
            aria-hidden="true"
          ></span>

          <span
            class="admin-liveboard-seg"
            *ngFor="let s of timelineSegments(r.userId)"
            [class.seg-work]="s.kind === 'work'"
            [class.seg-tt]="s.kind === 'tt'"
            [class.seg-idle]="s.kind === 'idle'"
            [class.is-active]="s.active"
            [style.left.%]="s.leftPct"
            [style.width.%]="s.widthPct"
            [title]="s.title"
          ></span>
        </div>
      </div>

      <div class="admin-empty" *ngIf="!loading() && rows().length === 0">
        Nenhum usuário encontrado.
      </div>
    </div>
  </section>

  <section class="admin-panel">
    <div class="admin-table">
      <div class="admin-row admin-row--head">
        <div>Usuário</div>
        <div>Contas</div>
        <div>Unidades</div>
        <div>Saldo (Gasto - TMA)</div>
        <div>Última conta</div>
        <div class="admin-timeline-head">
          <div class="admin-timeline-labels" aria-hidden="true">
            <span>00</span>
            <span>06</span>
            <span>12</span>
            <span>18</span>
            <span>24</span>
          </div>
          <div class="admin-timeline-track" aria-hidden="true"></div>
        </div>
      </div>

      <button class="admin-row admin-row--button" type="button" *ngFor="let r of rows()" (click)="openUser(r)">
        <div class="admin-user">
          <div class="admin-user-name">{{ r.username }}</div>
          <div class="admin-user-sub">
            <span class="admin-dot" [class.on]="isInProgress(r.userId) || isRecentlyActive(r.lastTxAtIso)"></span>
            <ng-container *ngIf="inProgressText(r.userId) as txt; else activeStatus">
              <span>{{ txt }}</span>
            </ng-container>
            <ng-template #activeStatus>
              <span>{{ isRecentlyActive(r.lastTxAtIso) ? 'Ativo' : '—' }}</span>
            </ng-template>
          </div>
        </div>
        <div class="admin-num">{{ r.txCount }}</div>
        <div class="admin-num">{{ r.doneUnits }}</div>
        <div class="admin-diff" [class.ok]="abs(r.diffSeconds) <= 600" [class.bad]="abs(r.diffSeconds) > 600">
          {{ formatDiff(r.diffSeconds) }}
        </div>
        <div class="admin-last">{{ formatLastSeen(r.lastTxAtIso) }}</div>

        <div class="admin-timeline-cell">
          <div class="admin-timeline-track">
            <span
              class="admin-timeline-now"
              *ngIf="timelineNowPct() !== null"
              [style.left.%]="timelineNowPct()!"
              aria-hidden="true"
            ></span>

            <span
              class="admin-timeline-marker"
              *ngFor="let m of timelineMarkers(r.userId)"
              [class.marker-start]="m.kind === 'day_start'"
              [class.marker-end]="m.kind === 'day_end'"
              [style.left.%]="m.leftPct"
              [title]="m.title"
              aria-hidden="true"
            ></span>

            <span
              class="admin-timeline-seg"
              *ngFor="let s of timelineSegments(r.userId)"
              [class.seg-work]="s.kind === 'work'"
              [class.seg-tt]="s.kind === 'tt'"
              [class.seg-idle]="s.kind === 'idle'"
              [class.is-active]="s.active"
              [style.left.%]="s.leftPct"
              [style.width.%]="s.widthPct"
              [title]="s.title"
            ></span>
          </div>
        </div>
      </button>

      <div class="admin-empty" *ngIf="!loading() && rows().length === 0">
        Nenhum usuário encontrado.
      </div>
    </div>
  </section>
</div>

<div
  class="sidebar-overlay"
  [class.is-open]="sidebarShown()"
  [class.is-closing]="sidebarClosing()"
  (click)="closeSidebar()"
  aria-hidden="true"
></div>

<aside
  id="adminSidebar"
  class="sidebar"
  [class.is-open]="sidebarOpen()"
  [class.is-closing]="sidebarClosing()"
  [attr.aria-hidden]="sidebarShown() ? 'false' : 'true'"
>
  <div class="sidebar-header">
    <div>
      <div class="sidebar-title">Admin</div>
      <div class="sidebar-greeting" *ngIf="helloName()">Oi, <span class="sidebar-greeting-name">{{ helloName() }}</span></div>
      <div class="sidebar-mode-pill">Painel</div>
    </div>
    <button class="sidebar-close" type="button" aria-label="Fechar menu" (click)="closeSidebar()">&times;</button>
  </div>

  <div class="sidebar-body">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Navegação</div>
      <button class="sidebar-action" type="button" (click)="goBack()">← Voltar</button>
      <a routerLink="/report" class="sidebar-action" style="text-decoration:none; display:block; text-align:center;" (click)="closeSidebar()">Ir para Relatório</a>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Ações</div>
      <button class="sidebar-action" type="button" (click)="refresh()" [disabled]="loading()">Atualizar</button>
      <button class="sidebar-action" type="button" (click)="toggleLive()">{{ liveEnabled() ? 'Ao vivo: ON' : 'Ao vivo: OFF' }}</button>
      <button class="sidebar-action" type="button" (click)="openBroadcastHistory()">Histórico</button>
      <button class="sidebar-action" type="button" (click)="openBroadcast()">Mensagem p/ todos</button>
      <button class="sidebar-action" type="button" (click)="openCorrectionRequests()">Solicitações de correção</button>
      <button class="sidebar-action sidebar-action--danger" type="button" (click)="logout()">Sair</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Modos</div>

      <div class="sidebar-row">
        <span>Sprint Mode</span>
        <label class="switch" style="margin-bottom:0;">
          <input
            type="checkbox"
            id="adminSidebarSprintModeToggle"
            [checked]="appConfig.sprintModeEnabled()"
            (change)="setSprintModeEnabled($any($event.target).checked)"
          />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Noir</div>

      <div class="sidebar-row">
        <span>Ativar</span>
        <label class="switch" style="margin-bottom:0;">
          <input
            type="checkbox"
            id="adminSidebarCompanionToggle"
            [checked]="!companion.hidden()"
            (change)="setCompanionEnabled($any($event.target).checked)"
          />
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>
</aside>

<div class="admin-modal-overlay" *ngIf="broadcastHistoryOpen()" (click)="closeBroadcastHistory()">
  <div class="admin-modal admin-modal--history" (click)="$event.stopPropagation()">
    <header class="admin-modal-head">
      <div>
        <div class="admin-modal-title">Histórico de mensagens (Admin)</div>
        <div class="admin-modal-sub">
          <span class="admin-muted">Clique em uma mensagem para ver quem já ouviu/viu.</span>
        </div>
      </div>
      <button class="admin-modal-close" type="button" (click)="closeBroadcastHistory()">✕</button>
    </header>

    <div class="admin-modal-scroll">
      <div class="admin-actions" style="justify-content:flex-end; margin-bottom: 10px;">
        <button class="sidebar-action" type="button" (click)="refreshBroadcastHistory()" [disabled]="broadcastHistoryLoading()">
          {{ broadcastHistoryLoading() ? 'Carregando…' : 'Atualizar' }}
        </button>
      </div>

      <div class="admin-error" *ngIf="broadcastHistoryError()">{{ broadcastHistoryError() }}</div>

      <div class="broadcast-grid">
        <div class="broadcast-list">
          <div class="broadcast-empty" *ngIf="!broadcastHistoryLoading() && broadcastHistoryRows().length === 0">
            Nenhuma mensagem.
          </div>

          <button
            class="broadcast-row"
            type="button"
            *ngFor="let b of broadcastHistoryRows()"
            [class.is-selected]="selectedBroadcastId() === b.id"
            (click)="selectBroadcast(b)"
          >
            <div class="broadcast-row-top">
              <div class="broadcast-row-title">
                {{ b.kind === 'danger' ? 'Alerta' : (b.kind === 'warning' ? 'Aviso' : 'Mensagem') }}
                <span class="admin-muted" *ngIf="b.created_by_username"> • {{ b.created_by_username }}</span>
              </div>
              <div class="admin-muted">{{ b.created_at | date:'dd/MM HH:mm' }}</div>
            </div>
            <div class="broadcast-row-msg">{{ b.message }}</div>
            <div class="broadcast-row-foot">
              <span class="admin-pill">Visto: {{ b.seenCount }}/{{ b.totalUsers }}</span>
            </div>
          </button>
        </div>

        <div class="broadcast-detail">
          <div class="broadcast-empty" *ngIf="!selectedBroadcast()">
            Selecione uma mensagem.
          </div>

          <ng-container *ngIf="selectedBroadcast()">
            <div class="broadcast-detail-title">Quem já viu/ouviu</div>
            <div class="admin-muted" style="margin-bottom: 10px;">
              {{ selectedBroadcastReads().length }} leituras
              <span *ngIf="selectedBroadcast()?.created_at"> • {{ selectedBroadcast()?.created_at | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>

            <div class="broadcast-empty" *ngIf="broadcastReadsLoading()">Carregando…</div>
            <div class="broadcast-empty" *ngIf="!broadcastReadsLoading() && selectedBroadcastReads().length === 0">Ninguém ainda.</div>

            <div class="broadcast-reads" *ngIf="!broadcastReadsLoading() && selectedBroadcastReads().length">
              <div class="broadcast-read" *ngFor="let r of selectedBroadcastReads()">
                <div class="broadcast-read-name">{{ r.username }}</div>
                <div class="admin-muted">{{ r.seen_at | date:'dd/MM HH:mm:ss' }}</div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="admin-modal-overlay" *ngIf="broadcastOpen()" (click)="closeBroadcast()">
  <div class="admin-modal admin-modal--small admin-modal--composer" (click)="$event.stopPropagation()">
    <header class="admin-modal-head">
      <div>
        <div class="admin-modal-title">Mensagem para todos</div>
        <div class="admin-modal-sub">
            <span class="admin-muted">Envia um aviso global que vira “correio de voz” no Noir (badge vermelho + reprodução ao clicar).</span>
        </div>
      </div>
      <button class="admin-modal-close" type="button" (click)="closeBroadcast()">✕</button>
    </header>

    <div class="admin-modal-scroll">
      <div class="admin-error" *ngIf="broadcastError()">{{ broadcastError() }}</div>

      <label class="admin-field" style="min-width: unset;">
        <span class="admin-field-label">Mensagem</span>
        <textarea
          class="admin-input"
          rows="6"
          placeholder="Ex: Pessoal, lembrem de padronizar o início da conta hoje."
          [ngModel]="broadcastText()"
          (ngModelChange)="broadcastText.set($event)"
        ></textarea>
      </label>
    </div>

    <div class="admin-modal-actions">
      <button class="sidebar-action" type="button" (click)="closeBroadcast()" [disabled]="broadcastSending()">Cancelar</button>
      <button
        class="sidebar-action"
        type="button"
        (click)="sendBroadcast()"
        [disabled]="broadcastSending() || !broadcastText().trim()"
      >
        {{ broadcastSending() ? 'Enviando…' : 'Enviar' }}
      </button>
    </div>
  </div>
</div>

<div class="admin-modal-overlay" *ngIf="correctionOpen()" (click)="closeCorrectionRequests()">
  <div class="admin-modal admin-modal--history" (click)="$event.stopPropagation()">
    <header class="admin-modal-head">
      <div>
        <div class="admin-modal-title">Solicitações de correção</div>
        <div class="admin-modal-sub">
          <span class="admin-muted">Aprove/rejeite e (se aprovar) aplique o patch na conta.</span>
        </div>
      </div>
      <button class="admin-modal-close" type="button" (click)="closeCorrectionRequests()">✕</button>
    </header>

    <div class="admin-modal-scroll">
      <div class="admin-actions" style="justify-content:flex-end; margin-bottom: 10px;">
        <button class="sidebar-action" type="button" (click)="refreshCorrectionRequests()" [disabled]="correctionLoading()">
          {{ correctionLoading() ? 'Carregando…' : 'Atualizar' }}
        </button>
      </div>

      <div class="admin-error" *ngIf="correctionError()">{{ correctionError() }}</div>

      <div class="corr-grid">
        <div class="corr-list">
          <div class="admin-empty" *ngIf="!correctionLoading() && correctionSortedRows().length === 0">
            Nenhuma solicitação.
          </div>

          <button
            class="corr-row"
            type="button"
            *ngFor="let r of correctionSortedRows()"
            [class.is-selected]="selectedCorrectionId() === r.id"
            (click)="selectCorrection(r)"
          >
            <div class="corr-row-top">
              <div class="corr-row-title">
                {{ r.userUsername || r.userId }}
                <span class="admin-muted" *ngIf="r.createdAt"> • {{ r.createdAt | date:'dd/MM HH:mm' }}</span>
              </div>
              <span
                class="corr-status"
                [class.pending]="(r.status || '').toLowerCase() === 'pending'"
                [class.approved]="(r.status || '').toLowerCase() === 'approved'"
                [class.rejected]="(r.status || '').toLowerCase() === 'rejected'"
              >
                {{ correctionStatusLabel(r.status) }}
              </span>
            </div>

            <div class="corr-row-msg">{{ r.userMessage }}</div>

            <div class="corr-row-foot">
              <span class="admin-muted" *ngIf="r.txSnapshot?.item">Conta: {{ r.txSnapshot?.item }}</span>
              <span class="admin-muted" *ngIf="r.txSnapshot?.type"> • Tipo: {{ r.txSnapshot?.type }}</span>
            </div>
          </button>
        </div>

        <div class="corr-detail">
          <div class="admin-empty" *ngIf="!selectedCorrection()">Selecione uma solicitação.</div>

          <ng-container *ngIf="selectedCorrection() as sel">
            <div class="corr-detail-title">Detalhes</div>
            <div class="corr-detail-sub">
              <span class="admin-pill" *ngIf="(sel.status || '').toLowerCase() === 'pending'">Pendente</span>
              <span class="admin-pill" *ngIf="(sel.status || '').toLowerCase() === 'approved'">Aprovada</span>
              <span class="admin-pill" *ngIf="(sel.status || '').toLowerCase() === 'rejected'">Rejeitada</span>
              <span class="admin-muted" *ngIf="sel.adminUsername"> • Admin: {{ sel.adminUsername }}</span>
              <span class="admin-muted" *ngIf="sel.resolvedAt"> • Resolvida: {{ sel.resolvedAt | date:'dd/MM HH:mm' }}</span>
            </div>

            <div class="corr-snapshot">
              <div class="corr-snapshot-title">Snapshot (do usuário)</div>
              <div class="corr-snapshot-grid">
                <div><span class="admin-muted">Item</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.item || '—' }}</div></div>
                <div><span class="admin-muted">Tipo</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.type || '—' }}</div></div>
                <div><span class="admin-muted">TMA</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.tma ?? '—' }}</div></div>
                <div><span class="admin-muted">Gasto</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.timeSpent ?? '—' }}</div></div>
                <div><span class="admin-muted">Status</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.finishStatus || '—' }}</div></div>
                <div><span class="admin-muted">SGSS</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.sgss || '—' }}</div></div>
                <div><span class="admin-muted">Tipo Empresa</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.tipoEmpresa || '—' }}</div></div>
                <div><span class="admin-muted">Timestamp</span><div class="corr-snapshot-value">{{ sel.txSnapshot?.timestamp || sel.txSnapshot?.createdAtIso || '—' }}</div></div>
              </div>
            </div>

            <div class="corr-editor">
              <div class="corr-editor-title">Patch (o que vai ser aplicado)</div>

              <div class="corr-form">
                <label class="admin-field" style="min-width: unset;">
                  <span class="admin-field-label">Item</span>
                  <input class="admin-input" type="text" [ngModel]="corrDraftItem()" (ngModelChange)="corrDraftItem.set($event)" />
                </label>

                <label class="admin-field" style="min-width: unset;">
                  <span class="admin-field-label">Tipo</span>
                  <input class="admin-input" type="text" [ngModel]="corrDraftType()" (ngModelChange)="corrDraftType.set($event)" />
                </label>

                <label class="admin-field" style="min-width: unset;">
                  <span class="admin-field-label">TMA</span>
                  <input class="admin-input" type="text" placeholder="HH:MM:SS (ex: 00:18:30)" [ngModel]="corrDraftTma()" (ngModelChange)="corrDraftTma.set($event)" />
                </label>

                <label class="admin-field" style="min-width: unset;">
                  <span class="admin-field-label">Gasto</span>
                  <input class="admin-input" type="text" placeholder="HH:MM:SS (ex: 00:22:10)" [ngModel]="corrDraftTimeSpent()" (ngModelChange)="corrDraftTimeSpent.set($event)" />
                </label>

                <label class="admin-field" style="min-width: unset;">
                  <span class="admin-field-label">Finish status</span>
                  <input class="admin-input" type="text" [ngModel]="corrDraftFinishStatus()" (ngModelChange)="corrDraftFinishStatus.set($event)" placeholder="Ex: concluida" />
                </label>

                <label class="admin-field" style="min-width: unset; grid-column: 1 / -1;">
                  <span class="admin-field-label">Nota do admin</span>
                  <textarea
                    class="admin-input"
                    rows="4"
                    placeholder="Explique o que foi feito (ou por que foi negado)."
                    [ngModel]="corrDraftAdminNote()"
                    (ngModelChange)="corrDraftAdminNote.set($event)"
                  ></textarea>
                </label>
              </div>

              <details class="admin-details corr-advanced">
                <summary class="admin-details-summary">Avançado</summary>
                <div class="corr-advanced-body">
                  <div class="corr-form" style="margin-top:10px;">
                    <label class="admin-field" style="min-width: unset;">
                      <span class="admin-field-label">SGSS</span>
                      <input class="admin-input" type="text" [ngModel]="corrDraftSgss()" (ngModelChange)="corrDraftSgss.set($event)" placeholder="Ex: 123456" />
                    </label>

                    <label class="admin-field" style="min-width: unset;">
                      <span class="admin-field-label">Tipo Empresa</span>
                      <input class="admin-input" type="text" [ngModel]="corrDraftTipoEmpresa()" (ngModelChange)="corrDraftTipoEmpresa.set($event)" placeholder="Ex: PJ" />
                    </label>

                    <label class="admin-field" style="min-width: unset;">
                      <span class="admin-field-label">Timestamp (client)</span>
                      <input class="admin-input" type="datetime-local" [ngModel]="corrDraftClientTimestampLocal()" (ngModelChange)="corrDraftClientTimestampLocal.set($event)" />
                    </label>

                    <label class="admin-field" style="min-width: unset;">
                      <span class="admin-field-label">Início (meta)</span>
                      <input class="admin-input" type="datetime-local" [ngModel]="corrDraftStartedAtLocal()" (ngModelChange)="corrDraftStartedAtLocal.set($event)" />
                    </label>

                    <label class="admin-field" style="min-width: unset;">
                      <span class="admin-field-label">Fim (meta)</span>
                      <input class="admin-input" type="datetime-local" [ngModel]="corrDraftEndedAtLocal()" (ngModelChange)="corrDraftEndedAtLocal.set($event)" />
                    </label>
                  </div>
                </div>
              </details>

              <div class="corr-actions">
                <button
                  class="sidebar-action sidebar-action--danger"
                  type="button"
                  (click)="deleteCorrectionRequest()"
                  [disabled]="correctionResolving() || (sel.status || '').toLowerCase() !== 'pending'"
                  title="Excluir sem responder"
                >
                  {{ correctionResolving() ? 'Processando…' : 'Excluir' }}
                </button>
                <button
                  class="sidebar-action sidebar-action--danger"
                  type="button"
                  (click)="rejectCorrection()"
                  [disabled]="correctionResolving() || (sel.status || '').toLowerCase() !== 'pending'"
                >
                  {{ correctionResolving() ? 'Processando…' : 'Rejeitar' }}
                </button>
                <button
                  class="sidebar-action"
                  type="button"
                  (click)="approveCorrection()"
                  [disabled]="correctionResolving() || (sel.status || '').toLowerCase() !== 'pending'"
                >
                  {{ correctionResolving() ? 'Processando…' : 'Aprovar e aplicar' }}
                </button>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="admin-modal-overlay" *ngIf="detailsOpen()" (click)="closeDetails()">
  <div class="admin-modal" (click)="$event.stopPropagation()">
    <header class="admin-modal-head">
      <div>
        <div class="admin-modal-title">{{ selectedRow()?.username || 'Usuário' }}</div>
        <div class="admin-modal-sub">
          <span class="admin-pill" *ngIf="selectedProfile()?.is_admin">Admin</span>
          <span class="admin-muted" style="margin-left:10px;">ID: {{ selectedRow()?.userId }}</span>
        </div>
      </div>
      <button class="admin-modal-close" type="button" (click)="closeDetails()">✕</button>
    </header>

    <section class="admin-modal-kpis">
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Quantidade de contas registradas hoje">Contas (qtd)</div>
        <div class="admin-kpi-value">{{ selectedTimeStats().workCount }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Quantidade de registros no Time Tracker hoje">TT (qtd)</div>
        <div class="admin-kpi-value">{{ selectedTimeStats().ttCount }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Tempo total gasto nas contas (hoje)">Tempo em contas</div>
        <div class="admin-kpi-value">{{ formatTime(selectedTimeStats().workSeconds) }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Tempo total registrado no Time Tracker (inclui idle)">Tempo em TT</div>
        <div class="admin-kpi-value">{{ formatTime(selectedTimeStats().ttSeconds) }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Parte do TT marcada como 'Ociosidade involuntaria'">Idle (invol.)</div>
        <div class="admin-kpi-value">{{ formatTime(selectedTimeStats().idleSeconds) }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Unidades estimadas (peso por item)">Unidades</div>
        <div class="admin-kpi-value">{{ selectedTimeStats().doneUnits }}</div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Saldo do dia só nas contas: (Gasto - TMA)">Saldo (contas)</div>
        <div class="admin-kpi-value" [class.ok]="abs(selectedTimeStats().diffSeconds) <= 600" [class.bad]="abs(selectedTimeStats().diffSeconds) > 600">
          {{ formatDiff(selectedTimeStats().diffSeconds) }}
        </div>
      </div>
      <div class="admin-kpi">
        <div class="admin-kpi-label" title="Ritmo estimado no período ativo (unidades por hora)">Ritmo (unid/h)</div>
        <div class="admin-kpi-value">{{ (selectedTimeStats().unitsPerHour || 0) | number:'1.1-1' }}</div>
      </div>
    </section>

    <section class="admin-visual-grid" *ngIf="detailsOpen()">
      <div class="admin-visual-card">
        <div class="admin-visual-title">Distribuição do tempo (contas vs TT)</div>
        <div class="admin-stacked" role="img" aria-label="Barra de distribuição do tempo">
          <div class="seg accounts" [style.width.%]="selectedVisual().accountsPct" title="Contas: {{ formatTime(selectedTimeStats().workSeconds) }}"></div>
          <div class="seg tt" [style.width.%]="selectedVisual().ttUsefulPct" title="TT útil: {{ formatTime(selectedTimeStats().usefulTtSeconds) }}"></div>
          <div class="seg idle" [style.width.%]="selectedVisual().idlePct" title="Idle (invol.): {{ formatTime(selectedTimeStats().idleSeconds) }}"></div>
        </div>
        <div class="admin-visual-legend">
          <div><span class="dot accounts"></span>Contas <b>{{ formatTime(selectedTimeStats().workSeconds) }}</b></div>
          <div><span class="dot tt"></span>TT útil <b>{{ formatTime(selectedTimeStats().usefulTtSeconds) }}</b></div>
          <div><span class="dot idle"></span>Idle <b>{{ formatTime(selectedTimeStats().idleSeconds) }}</b></div>
        </div>
      </div>

      <div class="admin-visual-card">
        <div class="admin-visual-title">Qualidade do registro</div>
        <div class="admin-meter-row">
          <div class="admin-meter-label">TT no período ativo</div>
          <div class="admin-meter">
            <div class="admin-meter-fill tt" [style.width.%]="selectedVisual().ttWindowPct"></div>
          </div>
          <div class="admin-meter-value">{{ selectedVisual().ttWindowPct | number:'1.0-0' }}%</div>
        </div>
        <div class="admin-meter-row">
          <div class="admin-meter-label">Idle dentro do TT</div>
          <div class="admin-meter">
            <div class="admin-meter-fill idle" [style.width.%]="selectedVisual().idleInTtPct"></div>
          </div>
          <div class="admin-meter-value">{{ selectedVisual().idleInTtPct | number:'1.0-0' }}%</div>
        </div>
      </div>

      <div class="admin-visual-card">
        <div class="admin-visual-title">Saldo (Gasto - TMA) • contas</div>
        <div class="admin-saldo-meter" title="0 é perfeito; positivo = acima do TMA; negativo = abaixo">
          <div class="admin-saldo-center"></div>
          <div class="admin-saldo-pos" [style.left.%]="selectedVisual().saldoMeterPct"></div>
        </div>
        <div class="admin-saldo-value" [class.ok]="abs(selectedTimeStats().diffSeconds) <= 600" [class.bad]="abs(selectedTimeStats().diffSeconds) > 600">
          {{ formatDiff(selectedTimeStats().diffSeconds) }}
        </div>
        <div class="admin-saldo-sub">(clamp visual: ±30min)</div>
      </div>
    </section>

    <section class="admin-modal-body">
      <div class="admin-modal-col">
        <h3 class="admin-h3">Top itens (hoje)</h3>
        <div class="admin-chips">
          <span class="admin-chip" *ngFor="let it of selectedTopItems()">{{ it[0] }} <b>×{{ it[1] }}</b></span>
          <div class="admin-empty" *ngIf="selectedTopItems().length === 0">Sem contas hoje.</div>
        </div>
      </div>

      <div class="admin-modal-col">
        <h3 class="admin-h3">Top Time Tracker (hoje)</h3>
        <div class="admin-chips">
          <span class="admin-chip" *ngFor="let it of selectedTopTimeTrackerItems()">{{ it[0] }} <b>×{{ it[1] }}</b></span>
          <div class="admin-empty" *ngIf="selectedTopTimeTrackerItems().length === 0">Sem Time Tracker hoje.</div>
        </div>
      </div>

      <div class="admin-modal-col">
        <h3 class="admin-h3">Registros recentes (hoje)</h3>
        <div class="admin-tx-list">
          <div class="admin-tx" *ngFor="let t of selectedTx().slice(0, 30)">
            <div class="admin-tx-main">
              <div class="admin-tx-item">{{ t.item }} <span class="admin-type">{{ (t.type || '') }}</span></div>
              <div class="admin-tx-time">{{ formatIsoShort(t.created_at) }}</div>
            </div>
            <div class="admin-tx-meta">
              <span class="admin-mini">TMA: {{ formatTime(t.tma) }}</span>
              <span class="admin-mini">Gasto: {{ formatTime(t.time_spent) }}</span>
              <span class="admin-mini" [class.ok]="abs((t.time_spent||0)-(t.tma||0)) <= 600" [class.bad]="abs((t.time_spent||0)-(t.tma||0)) > 600">
                Saldo: {{ formatDiff((t.time_spent||0)-(t.tma||0)) }}
              </span>
              <span class="admin-mini" *ngIf="t.sgss">SGSS: {{ t.sgss }}</span>
              <span class="admin-mini" *ngIf="t.tipo_empresa">Tipo: {{ t.tipo_empresa }}</span>
            </div>
          </div>
          <div class="admin-empty" *ngIf="selectedTx().length === 0">Sem registros hoje.</div>
        </div>
      </div>

      <div class="admin-modal-col">
        <details class="admin-details">
          <summary class="admin-details-summary">Detalhes (horários e taxas)</summary>
          <div class="admin-summary" style="margin-top:10px;">
            <div title="Horário do primeiro registro do dia"><b>Primeiro registro:</b> {{ selectedTimeStats().firstIso ? formatIsoShort(selectedTimeStats().firstIso!) : '—' }}</div>
            <div title="Horário do último registro do dia"><b>Último registro:</b> {{ selectedTimeStats().lastIso ? formatIsoShort(selectedTimeStats().lastIso!) : '—' }}</div>
            <div title="Tempo entre o primeiro e o último registro (não é tempo trabalhado; é o intervalo)"><b>Período ativo (1º→último):</b> {{ formatTime(selectedTimeStats().windowSeconds) }}</div>
            <div title="Soma do tempo registrado em contas + Time Tracker"><b>Tempo total (contas + TT):</b> {{ formatTime(selectedTimeStats().totalSeconds) }}</div>
            <div title="TT sem o tempo de idle involuntário"><b>TT útil (TT - idle):</b> {{ formatTime(selectedTimeStats().usefulTtSeconds) }}</div>
            <div title="Contas por hora calculado dentro do período ativo"><b>Ritmo (contas/h no período):</b> {{ (selectedTimeStats().accountsPerHour || 0) | number:'1.1-1' }}</div>
          </div>
        </details>
      </div>

      <div class="admin-modal-col">
        <h3 class="admin-h3">Top por tempo — Contas (hoje)</h3>
        <div class="admin-breakdown">
          <div class="admin-break-row" *ngFor="let r of selectedTopByTime()">
            <div class="admin-break-item">{{ r.item }}</div>
            <div class="admin-break-meta">{{ formatTime(r.seconds) }} • {{ r.count }}× • média {{ formatTime(r.avgSeconds) }}</div>
          </div>
          <div class="admin-empty" *ngIf="selectedTopByTime().length === 0">Sem contas hoje.</div>
        </div>
      </div>

      <div class="admin-modal-col">
        <h3 class="admin-h3">Top por tempo — Time Tracker (hoje)</h3>
        <div class="admin-breakdown">
          <div class="admin-break-row" *ngFor="let r of selectedTopTimeTrackerByTime()">
            <div class="admin-break-item">{{ r.item }}</div>
            <div class="admin-break-meta">{{ formatTime(r.seconds) }} • {{ r.count }}× • média {{ formatTime(r.avgSeconds) }}</div>
          </div>
          <div class="admin-empty" *ngIf="selectedTopTimeTrackerByTime().length === 0">Sem Time Tracker hoje.</div>
        </div>
      </div>

      <!-- Work hours graphic -->
      <div class="admin-modal-col">
        <h3 class="admin-h3">Gráfico de Horas Trabalhadas (hoje)</h3>
        <canvas id="workHoursChart" class="admin-workhours-canvas"></canvas>
        <div id="workHoursLegend" class="admin-chart-legend"></div>
      </div>
      <div class="admin-modal-col" *ngIf="selectedHourlyBreakdown().length">
        <details class="admin-details" open>
          <summary class="admin-details-summary">Detalhe por hora</summary>
          <div class="hourly-breakdown" style="margin-top:10px;">
            <table class="hourly-breakdown-table">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Contas</th>
                  <th>TT útil</th>
                  <th>Idle</th>
                  <th>Total</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of selectedHourlyBreakdown()">
                  <td class="hour">{{ r.hour.toString().padStart(2, '0') }}:00</td>
                  <td>{{ formatTime(r.accountsSeconds) }} <span class="muted">({{ r.accountsCount }})</span></td>
                  <td>{{ formatTime(r.usefulTtSeconds) }} <span class="muted">({{ r.ttCount }})</span></td>
                  <td>{{ formatTime(r.idleSeconds) }}</td>
                  <td><b>{{ formatTime(r.totalSeconds) }}</b></td>
                  <td class="actions">
                    <span class="muted" *ngIf="!r.actions.length">—</span>
                    <span *ngIf="r.actions.length">{{ r.actions.slice(0, 3).join(' · ') }}</span>
                    <span class="muted" *ngIf="r.actions.length > 3"> +{{ r.actions.length - 3 }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </details>
      </div>
    </section>
  </div>
</div>
